# PRD §7.1 – Daily price updater with git amend (keeps repo small)
name: Update Market Prices
on:
  schedule:
    - cron: '0 6 * * *'   # Daily 6 AM UTC
  workflow_dispatch:
permissions:
  contents: write
  pull-requests: write

jobs:
  update-prices:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Exchange Rates
        run: |
          mkdir -p src/data/prices
          curl -sf "https://api.exchangerate-api.com/v4/latest/USD" \
            -o src/data/prices/rates.json || echo '{"rates":{}}' > src/data/prices/rates.json

      - name: Fetch Gold & Silver Prices (MetalPriceAPI)
        env:
          METALPRICEAPI_KEY: ${{ secrets.METALPRICEAPI_KEY }}
        run: |
          if [ -n "$METALPRICEAPI_KEY" ]; then
            curl -sf "https://api.metalpriceapi.com/v1/latest?api_key=$METALPRICEAPI_KEY&base=USD&currencies=XAU,XAG" \
              -o /tmp/metalpriceapi.json

            node -e '
              const fs = require("fs");
              const raw = fs.readFileSync("/tmp/metalpriceapi.json", "utf8");
              const data = JSON.parse(raw);
              const rates = data.rates || {};

              // MetalPriceAPI common shape with base=USD is:
              // rates.XAU = ounces of gold per 1 USD
              // rates.XAG = ounces of silver per 1 USD
              const xauPerUsd = rates.XAU ?? rates.USDXAU;
              const xagPerUsd = rates.XAG ?? rates.USDXAG;

              if (!xauPerUsd || !xagPerUsd) {
                throw new Error("Missing XAU/XAG rates from MetalPriceAPI response");
              }

              const usdPerOunceGold = 1 / Number(xauPerUsd);
              const usdPerOunceSilver = 1 / Number(xagPerUsd);
              const OUNCE_TO_GRAM = 31.1034768;

              const gram24 = usdPerOunceGold / OUNCE_TO_GRAM;
              const goldOut = {
                price_gram_24k: Number(gram24.toFixed(6)),
                price_gram_22k: Number((gram24 * 22 / 24).toFixed(6)),
                price_gram_21k: Number((gram24 * 21 / 24).toFixed(6)),
                price_gram_18k: Number((gram24 * 18 / 24).toFixed(6)),
                currency: "USD",
                timestamp: new Date().toISOString(),
                source: "metalpriceapi",
              };

              const silverOut = {
                price_gram: Number((usdPerOunceSilver / OUNCE_TO_GRAM).toFixed(6)),
                currency: "USD",
                timestamp: new Date().toISOString(),
                source: "metalpriceapi",
              };

              fs.writeFileSync("src/data/prices/gold.json", JSON.stringify(goldOut, null, 2) + "\n");
              fs.writeFileSync("src/data/prices/silver.json", JSON.stringify(silverOut, null, 2) + "\n");
            '
          else
            echo "No METALPRICEAPI_KEY — keeping committed gold/silver prices"
          fi

      - name: Fetch Crypto Prices (CoinGecko free tier)
        run: |
          curl -sf \
            "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,tether,binancecoin,solana,cardano,ripple,polkadot,dogecoin,avalanche-2,chainlink,litecoin,polygon,stellar,monero,uniswap,cosmos,algorand,filecoin,hedera&vs_currencies=usd" \
            -o src/data/prices/crypto.json \
            || echo '{"bitcoin":{"usd":65000},"ethereum":{"usd":3500}}' > src/data/prices/crypto.json

      - name: Write last-update timestamp
        run: date -u +"%Y-%m-%dT%H:%M:%SZ" > src/data/prices/last-update.txt

      - name: Create Pull Request with Price Updates
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: |
            src/data/prices/
          commit-message: "chore(prices): daily market data update"
          branch: "bot/daily-price-update"
          delete-branch: true
          title: "chore(prices): daily market data update"
          body: |
            Automated daily update of:
            - FX rates
            - Gold/Silver prices
            - Crypto prices
            - last-update timestamp
